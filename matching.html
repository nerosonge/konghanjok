<!DOCTYPE html>
<html lang="ko">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WL5RWLPL');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹¤ì‹œê°„ ë§¤ì¹­ ì¤‘ | ì½©í•œìª½</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #1a0f0f;
      --bg-gradient: radial-gradient(120% 120% at 10% 10%, #2d1515 0%, #1a0f0f 40%, #0d0808 100%);
      --ink: #f5e6e6;
      --muted: #a08080;
      --brand: #c0392b;
      --brand-strong: #922b21;
      --accent: #27ae60;
      --surface: rgba(255, 255, 255, 0.08);
      --border: rgba(160, 80, 80, 0.2);
      --radius: 20px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      background-image: var(--bg-gradient);
      color: var(--ink);
      overflow-x: hidden;
    }

    .page {
      width: 100%;
      max-width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 56px 16px 24px;
      box-sizing: border-box;
    }

    @media (min-width: 720px) {
      .page {
        flex-direction: row;
        align-items: stretch;
        gap: 0;
        padding: 56px 24px 24px;
      }
    }

    .back {
      position: absolute;
      top: 16px;
      left: 16px;
      color: var(--muted);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 10;
    }
    .back:hover { color: var(--brand-strong); }

    /* ì™¼ìª½: ë§¤ì¹­ ì¤‘ / ë¡œë”© */
    .matching-side {
      flex: 0 0 auto;
      width: 100%;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 220px;
      padding: 24px 16px;
      position: relative;
      box-sizing: border-box;
    }

    @media (min-width: 720px) {
      .matching-side {
        flex: 0 0 42%;
        min-height: 100vh;
        padding: 60px 40px;
      }
    }

    .matching-side.complete .loading-content { display: none; }
    .matching-side.complete .complete-content { display: flex; }
    .loading-content { display: flex; flex-direction: column; align-items: center; gap: 24px; }
    .complete-content { display: none; flex-direction: column; align-items: center; gap: 20px; }

    .loading-spinner {
      width: 64px;
      height: 64px;
      border: 4px solid rgba(255,255,255,0.15);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: rgba(255,255,255,0.9);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .loading-sub {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .complete-badge {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
    }

    .complete-desc {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.8);
      text-align: center;
    }

    .btn-game-entry {
      display: inline-block;
      margin-top: 12px;
      padding: 16px 32px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(130deg, var(--brand-strong), var(--brand));
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(192, 57, 43, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-game-entry:hover {
      transform: scale(1.03);
      box-shadow: 0 12px 32px rgba(192, 57, 43, 0.5);
    }

    /* ì˜¤ë¥¸ìª½: ì„œë¹„ìŠ¤ ì„¤ë“ ì½˜í…ì¸  */
    .copy-side {
      flex: 1;
      width: 100%;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px 16px 32px;
      overflow-y: auto;
      text-align: center;
      box-sizing: border-box;
    }

    @media (min-width: 720px) {
      .copy-side {
        padding: 60px 48px;
        max-width: 58%;
      }
    }

    .copy-side .hero-img {
      width: auto;
      max-width: min(200px, 50vw);
      height: auto;
      margin: 0 auto 20px;
      display: block;
      filter: drop-shadow(0 12px 32px rgba(0,0,0,0.4));
    }

    .copy-side .hook {
      font-size: clamp(1.25rem, 5vw, 1.8rem);
      font-weight: 900;
      margin: 0 0 12px;
      color: #fff;
      line-height: 1.3;
      letter-spacing: -0.02em;
      max-width: 100%;
    }

    .copy-side .hook span { color: var(--brand-strong); }

    .copy-side .hook-sub {
      font-size: clamp(0.8rem, 2.2vw, 0.9rem);
      color: var(--muted);
      margin: -4px 0 14px;
      line-height: 1.45;
    }

    .copy-side .tag {
      font-size: clamp(0.95rem, 3vw, 1rem);
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .copy-side .one-liner {
      font-size: clamp(0.95rem, 2.8vw, 1.05rem);
      line-height: 1.55;
      color: rgba(255,255,255,0.9);
      margin: 0 0 10px;
      font-weight: 500;
      max-width: 100%;
    }

    .copy-side .punch {
      font-size: clamp(1rem, 3vw, 1.1rem);
      font-weight: 800;
      color: #fff;
      margin-top: 8px;
    }

    .copy-side .eco {
      margin-top: 18px;
      line-height: 1.5;
    }

    .copy-side .eco strong {
      font-size: clamp(1.1rem, 3.5vw, 1.25rem);
      font-weight: 900;
      color: var(--accent);
      display: block;
      margin-bottom: 4px;
    }

    .copy-side .eco-small {
      display: block;
      font-size: clamp(0.75rem, 2vw, 0.85rem);
      color: var(--muted);
    }

    .copy-side .eco-tagline {
      display: block;
      font-size: clamp(0.9rem, 2.5vw, 0.95rem);
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      margin-top: 6px;
    }

    .no-match-msg {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 24px;
      color: var(--muted);
    }
    .no-match-msg .btn-back {
      display: inline-block;
      margin-top: 16px;
      padding: 14px 28px;
      border-radius: 14px;
      background: var(--surface);
      color: var(--ink);
      text-decoration: none;
      font-weight: 700;
      border: 2px solid var(--border);
    }
    .no-match-msg .btn-back:hover { border-color: var(--brand); color: #fff; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WL5RWLPL"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <a class="back" href="match.html">â† ë§¤ì¹­ìœ¼ë¡œ</a>

  <div class="page">
    <section class="matching-side" id="matchingSide">
      <div class="loading-content">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p class="loading-text">ë§¤ì¹­ ì¤‘...</p>
        <p class="loading-sub">ë‚˜ì™€ ê¼­ ë§ëŠ” ìƒëŒ€ë¥¼ ì°¾ê³  ìˆì–´ìš”</p>
      </div>
      <div class="complete-content">
        <p class="complete-badge">âœ“ ë§¤ì¹­ ì™„ë£Œ!</p>
        <p class="complete-desc" id="completeDesc">ìƒëŒ€ë¥¼ ì°¾ì•˜ì–´ìš”.<br>ê²Œì„ì—ì„œ ì´ê¸°ë©´ ì—ì–´íŒŸ ì™„ì „ì²´ë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
        <a href="#" class="btn-game-entry" id="btnGameEntry">ê²Œì„ ì…ì¥í•˜ê¸°</a>
      </div>
    </section>

    <section class="copy-side">
      <img src="assets/airpods-complete.png" alt="" class="hero-img">
      <p class="tag">ë¶„ì‹¤ë„ ì½˜í…ì¸ ë¡œ! ë„íŒŒë¯¼ í•œíŒ ê±°ë˜~ ğŸ§</p>
      <h2 class="hook"><span>85%</span> ì ˆê° Â· <span>200%</span> ë” ì¬ë°Œê²Œ</h2>
      <p class="hook-sub">ìƒˆë¡œ ì‚¬ë©´ 11ë§Œ ì›, ì´ê¸°ë©´ 1ë§Œ ì›ëŒ€ë¡œ ì™„ì „ì²´ í•©ì²´!</p>
      <p class="one-liner">ì´ê¸°ë©´ ì™„ì „ì²´ ê°€ì ¸ê°€ê³ , ìˆ˜ìˆ˜ë£Œë§Œ ê¸°ë¶„ ì¢‹ê²Œ ë‚´ë©´ ë~ ğŸ’¸</p>
      <p class="punch">í•œìª½ë§Œ ìˆì–´ë„ ê´œì°®ì•„. ê²Œì„ í•œ íŒ ì´ê¸°ë©´ ì™„ì „ì²´ ë‚´ ê±°! ê¸°ë¶„ ì¢‹ê²Œ í•œíŒ í•´ë³¼ê¹Œìš”? ğŸ˜Š</p>
      <p class="eco"><strong>ECO!</strong><span class="eco-small">ì „ì íê¸°ë¬¼ ìµœì†Œí™”</span><span class="eco-tagline">ì„¸ìƒì˜ ëª¨ë“  ì½©ì´ ë‹¤ì‹œ ì§ì„ ì°¾ëŠ” ê·¸ë‚ ê¹Œì§€!</span></p>
    </section>
  </div>

  <div class="no-match-msg hidden" id="noMatchMsg">
    <p>ì•„ì§ ì¤€ë¹„ëœ íŒŒíŠ¸ë„ˆê°€ ì—†ì–´ìš”.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”!</p>
    <a href="match.html" class="btn-back">ë§¤ì¹­ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <div class="no-match-msg hidden" id="realMatchFailMsg">
    <p>ì‹¤ì œ ìƒëŒ€ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.<br>ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ AIì™€ ì—°ìŠµí•´ ë³´ì„¸ìš”.</p>
    <a href="match.html" class="btn-back" id="retryMatchBtn">ë‹¤ì‹œ ë§¤ì¹­</a>
    <a href="#" class="btn-back" id="aiPracticeBtn" style="margin-top: 12px;">AIì™€ ì—°ìŠµí•˜ê¸°</a>
  </div>

  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function () {
      const MATCH_DURATION_MS = 4000;
      const key = 'matchPending';
      const data = sessionStorage.getItem(key);

      const matchingSide = document.getElementById('matchingSide');
      const completeDesc = document.getElementById('completeDesc');
      const btnGameEntry = document.getElementById('btnGameEntry');
      const noMatchMsg = document.getElementById('noMatchMsg');
      const loadingText = matchingSide.querySelector('.loading-text');

      if (!data) {
        document.querySelector('.page').classList.add('hidden');
        noMatchMsg.classList.remove('hidden');
        return;
      }

      let payload;
      try {
        payload = JSON.parse(data);
      } catch (e) {
        noMatchMsg.classList.remove('hidden');
        document.querySelector('.page').style.display = 'none';
        return;
      }

      if (payload.noMatch) {
        matchingSide.querySelector('.loading-content').innerHTML = '<p class="loading-text">ë§¤ì¹­ ê²°ê³¼ ì—†ìŒ</p>';
        setTimeout(() => {
          sessionStorage.removeItem(key);
          noMatchMsg.classList.remove('hidden');
          document.querySelector('.page').classList.add('hidden');
        }, 1500);
        return;
      }

      function getAiDestinyUrl() {
        return 'destiny.html?' + new URLSearchParams({
          mySide: payload.mySide,
          model: payload.model,
          condition: payload.condition,
          oppModel: payload.oppModel,
          oppSide: payload.oppSide,
          oppCondition: payload.oppCondition
        }).toString();
      }

      function showRealMatchFail() {
        var failEl = document.getElementById('realMatchFailMsg');
        var aiBtn = document.getElementById('aiPracticeBtn');
        if (failEl && aiBtn) {
          aiBtn.href = getAiDestinyUrl();
          document.querySelector('.page').classList.add('hidden');
          failEl.classList.remove('hidden');
        }
      }

      function goDestinyWithRoom(roomId) {
        sessionStorage.removeItem(key);
        location.href = 'destiny.html?roomId=' + encodeURIComponent(roomId);
      }

      function genUserId() {
        var id = sessionStorage.getItem('konghanjok_user_id');
        if (!id) {
          id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
          sessionStorage.setItem('konghanjok_user_id', id);
        }
        return id;
      }

      if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY && typeof supabase !== 'undefined') {
        try {
          var supabaseClient = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          var uid = genUserId();
          var mySide = payload.mySide;
          var oppSide = mySide === 'left' ? 'right' : 'left';
          var queueKey = (payload.model + '_' + mySide).replace(/\s+/g, '_');
          var oppositeKey = (payload.model + '_' + oppSide).replace(/\s+/g, '_');

          if (loadingText) loadingText.textContent = 'ì‹¤ì œ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...';

          supabaseClient.from('waiting').insert({
            queue_key: queueKey,
            user_id: uid,
            cond: payload.condition
          }).select('id').single().then(function(res) {
            if (res.error) {
              showRealMatchFail();
              return;
            }
            var myWaitingId = res.data.id;

            var channelMine = supabaseClient.channel('waiting-mine-' + myWaitingId)
              .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'waiting', filter: 'id=eq.' + myWaitingId }, function(p) {
                if (p.new && p.new.room_id) {
                  supabaseClient.removeChannel(channelMine);
                  supabaseClient.removeChannel(channelOpp);
                  supabaseClient.from('waiting').delete().eq('id', myWaitingId).then(function() {});
                  goDestinyWithRoom(p.new.room_id);
                }
              })
              .subscribe();

            function tryMatch() {
              supabaseClient.from('waiting').select('id, user_id, cond').eq('queue_key', oppositeKey).is('room_id', null).limit(1).then(function(r) {
                if (r.error || !r.data || r.data.length === 0) return;
                var opp = r.data[0];
                if (opp.user_id === uid) return;

                var playerLeft = mySide === 'left' ? uid : opp.user_id;
                var playerRight = mySide === 'right' ? uid : opp.user_id;
                var conditionLeft = mySide === 'left' ? payload.condition : (opp.cond || 'A');
                var conditionRight = mySide === 'right' ? payload.condition : (opp.cond || 'A');
                var scores = {};
                scores[playerLeft] = 0;
                scores[playerRight] = 0;
                var choices = {};
                choices[playerLeft] = null;
                choices[playerRight] = null;

                supabaseClient.from('rooms').insert({
                  player_left: playerLeft,
                  player_right: playerRight,
                  model: payload.model,
                  condition_left: conditionLeft,
                  condition_right: conditionRight,
                  scores: scores,
                  round: 1,
                  choices: choices,
                  phase: 'choose'
                }).select('id').single().then(function(roomRes) {
                  if (roomRes.error) return;
                  var roomId = roomRes.data.id;
                  supabaseClient.from('waiting').update({ room_id: roomId }).eq('id', opp.id).is('room_id', null).select('id').then(function(up) {
                    if (!up.error && up.data && up.data.length > 0) {
                      supabaseClient.removeChannel(channelMine);
                      supabaseClient.removeChannel(channelOpp);
                      supabaseClient.from('waiting').delete().eq('id', myWaitingId).then(function() {});
                      goDestinyWithRoom(roomId);
                    }
                  });
                });
              });
            }

            var channelOpp = supabaseClient.channel('waiting-opp-' + oppositeKey.replace(/[^a-zA-Z0-9_-]/g, '_'))
              .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'waiting', filter: 'queue_key=eq.' + oppositeKey }, tryMatch)
              .subscribe();

            tryMatch();
            var poll = setInterval(tryMatch, 2000);
            setTimeout(function() {
              clearInterval(poll);
              if (!document.getElementById('realMatchFailMsg').classList.contains('hidden')) return;
              if (document.querySelector('.page').classList.contains('hidden')) return;
              showRealMatchFail();
            }, 60000);
          }).catch(function() {
            showRealMatchFail();
          });
        } catch (e) {
          showRealMatchFail();
        }
      } else {
        showRealMatchFail();
      }
    })();
  </script>
</body>
</html>
